<div class="tree-custom-class__container">
  @for (node of treeNodes$ | async; track node) {
    @if (node === TREE_LOADER) {
      <tui-loader [showLoader]="true" [overlay]="true" size="s"></tui-loader>
    } @else {
      @if (defaultNodeOpenedState() === undefined) {
        <tui-tree
          class="tui_tree--not-collapsed"
          [value]="node"
          [content]="contentTemplate"
          [childrenHandler]="childrenHandler"
        >
        </tui-tree>
      } @else {
        <tui-tree
          [value]="node"
          [content]="contentTemplate"
          [childrenHandler]="childrenHandler"
          [tuiTreeController]="!!defaultNodeOpenedState()"
          [map]="openedNodesState()"
          (toggled)="onToggle($event)"
        >
        </tui-tree>
      }
    }
  }
</div>

<ng-template #contentTemplate let-node>
  @let isChecked = checkedNodesState().get(node);

  @if (node === TREE_LOADER) {
    <tui-loader [showLoader]="true" [overlay]="true" size="s"></tui-loader>
  } @else if (nodeTemplate()) {
    <ng-container
      [ngTemplateOutlet]="nodeTemplate()"
      [ngTemplateOutletContext]="{ node, isChecked, onChecked }"
    ></ng-container>
  } @else {
    <label tuiLabel class="tree-custom-class__label-checkbox-container">
      <input
        size="s"
        tuiCheckbox
        type="checkbox"
        [ngModel]="isChecked"
        (ngModelChange)="onChecked(node, $event)"
      />
      <small>{{ node.name }}</small>
    </label>
  }
</ng-template>
