<section class="register-table__section">
  <tui-scrollbar class="register-table__scrollable" (scrollend)="saveScrollEndPosition()">
    <tui-loader class="register-table__loader" [showLoader]="isLoading() || false" [overlay]="true">
      <table
        tuiTable
        class="table"
        stickyRelative
        [columns]="columnsWithCheckboxes()"
        [style.width.px]="tableWidth()"
        tuiSortBy=""
        (sortChange)="sortChange($event)"
      >
        <thead>
          @for (hrow of headerRows(); track $index) {
            <tr tuiThGroup>
              @if ($first && checkboxColumn()) {
                <th
                  tuiTh
                  *tuiHead="CHECKBOX_SELECTOR_KEY"
                  class="register-table__th-background--table-cell-blue register-table__cell-icon register-table__cell-checkbox-selector"
                  [style.width.px]="CHECKBOX_SELECTOR_WIDTH_PX"
                  [sorter]="null"
                  [rowSpan]="maxDepth()"
                >
                  <sproc-checkbox-selector
                    [selected]="selectedIds()"
                    [totalRecords]="totalRecords()"
                    [loading]="isSelectloading()"
                    [disabled]="checkboxDisabled()"
                    (onApply)="selectChanged.emit($event)"
                  ></sproc-checkbox-selector>
                </th>
              }
              @for (cell of hrow; track cell.col.name) {
                @let thClass = cell.col.class ?? '';
                @let thType = cell.col.type;
                @let thName = cell.col.name;
                @let sortable = checkAvailableColumnSorting(cell.col);
                @let resizeBlocked = checkResizeBlocked(cell.col);
                <th
                  tuiTh
                  tuiResizable
                  *tuiHead="thName"
                  [ngClass]="['register-table__th', thType | classByType, thClass]"
                  [stickyLeft]="cell.col.fixed ?? (thName | stickyColumn: stickyLeftIds())"
                  [stickyRight]="cell.col.fixed ?? (thName | stickyColumn: stickyRightIds())"
                  [stylesOnSticky]="stickyThStyle"
                  [style]="cell.col.headerStyle ?? ''"
                  [style.min-width.px]="getThWidth(thName)"
                  [style.width.px]="getThWidth(thName)"
                  [style.max-width.px]="getThWidth(thName)"
                  [tuiSortable]="sortable"
                  [sorter]="sortable ? setThName(thName) : null"
                  [tuiHint]="cell.col.tooltipText ?? null"
                  [rowSpan]="cell.rowspan"
                  [colSpan]="cell.colspan"
                  [attr.order]="columnOrders.get(thName)?.options?.order"
                >
                  @if (cell.col.isHeadTemplate) {
                    @let thProjection = getProjectionHeaderByName(thName);

                    @if (thProjection) {
                      <ng-container
                        [ngTemplateOutlet]="thProjection"
                        [ngTemplateOutletContext]="{
                          $implicit: cell.col,
                        }"
                      ></ng-container>
                    }
                  } @else {
                    @switch (thType) {
                      @case (EColumnDataType.ICON) {
                        <tui-icon
                          class="register-table--icon-color"
                          [icon]="cell.col.value!"
                        ></tui-icon>
                      }
                      @case (EColumnDataType.ICON_SVG) {
                        <img [src]="cell.col.value" [alt]="thName" />
                      }
                      @case (EColumnDataType.TEXT) {
                        @if (cell.col.svgSrc) {
                          <img [src]="cell.col.svgSrc" [alt]="thName" />
                        }
                        <span class="text-overflow--ellipsis" [ngStyle]="cell.col.textStyle">
                          {{ cell.col.value }}
                        </span>
                      }
                      @case (EColumnDataType.NUM) {
                        <span [ngStyle]="cell.col.textStyle">
                          {{ cell.col.value }}
                        </span>
                      }
                      @case (EColumnDataType.DATE) {
                        <span [ngStyle]="cell.col.textStyle">
                          {{ cell.col.value }}
                        </span>
                      }
                      @case (EColumnDataType.CHECKBOX) {
                        {{ cell.col.value }}
                      }
                    }
                  }
                  @if (!resizeBlocked) {
                    <div
                      class="register-table__cell-resizer"
                      [tuiResizer]="[1, 0]"
                      (tuiSizeChange)="thResizeChanges(cell.col.name, $event[0])"
                      (click)="$event.stopPropagation()"
                    ></div>
                  }
                </th>
              }
            </tr>
          }
        </thead>
        @let rows = rowData();
        <tbody tuiTbody>
          @for (row of rows; track row.id) {
            @let state = stateObjects?.();
            @let trSelected =
              state
                ? state.get(row.id)?.state === ERegisterObjectState.SELECTED
                : selectedIds().has(row.id);

            <tr
              #bodyRow
              tuiTr
              class="register-table__row"
              [class.selected]="trSelected"
              [class.shift-pressed]="markRowBeforeSelect(row)"
              (mouseenter)="onRowHover(row)"
              (mouseleave)="onRowHover(null)"
              (click)="onRowClick($event, row)"
              (dblclick)="rowDblClick.emit(row)"
            >
              @if (checkboxColumn()) {
                <td
                  tuiTd
                  *tuiCell="CHECKBOX_SELECTOR_KEY"
                  class="register-table__cell-checkbox-selector"
                >
                  <input
                    tuiCheckbox
                    size="s"
                    type="checkbox"
                    class="checkbox"
                    [checked]="trSelected"
                    [disabled]="checkboxDisabled()"
                  />
                </td>
              }
              @for (columnData of leaves(); track columnData.name) {
                @let tdType = columnData.type;
                @let tdKey = columnData.name;
                @let tdValue = row[tdKey];
                @let tdClass = columnData.classTd ?? '';

                <td
                  tuiTd
                  *tuiCell="tdKey"
                  [ngClass]="[tdType | classByType: 'td', tdClass]"
                  [stickyLeft]="tdKey | stickyColumn: stickyLeftIds()"
                  [stickyRight]="tdKey | stickyColumn: stickyRightIds()"
                  [stylesOnSticky]="stickyTdStyle"
                >
                  @if (columnData.isTemplate) {
                    @let tdProjection = getProjectionCellByName(tdKey);

                    @if (tdProjection) {
                      <ng-container
                        [ngTemplateOutlet]="tdProjection"
                        [ngTemplateOutletContext]="{
                          $implicit: tdValue,
                          row,
                        }"
                      ></ng-container>
                    }
                  } @else {
                    @switch (tdType) {
                      @case (EColumnDataType.ICON) {
                        @if (tdValue) {
                          <tui-icon
                            class="register-table--icon-color"
                            [icon]="columnData.value!"
                          ></tui-icon>
                        }
                      }
                      @case (EColumnDataType.ICON_SVG) {
                        @if (tdValue) {
                          <img [src]="columnData.value" [alt]="tdKey" />
                        }
                      }
                      @case (EColumnDataType.CHECKBOX) {
                        <input
                          tuiCheckbox
                          size="s"
                          type="checkbox"
                          class="checkbox"
                          [checked]="!!tdValue"
                          [disabled]="true"
                        />
                      }
                      @case (EColumnDataType.TEXT) {
                        <span [tuiHint]="tdValue">
                          {{ tdValue ?? '' }}
                        </span>
                        <span>
                          {{ tdValue ? columnData.postfix : '' }}
                        </span>
                      }
                      @case (EColumnDataType.NUM) {
                        {{ tdValue ?? '' | number: columnData.numberPipe }}
                        {{ tdValue ? columnData.postfix : '' }}
                      }
                      @case (EColumnDataType.DATE) {
                        {{
                          (tdValue
                            | formatDate
                              : ETimezone.UTC
                              : columnData.datePattern ?? EDatePattern.DATE_TIME_WITHOUT_SECONDS
                              : (timeZoneChanges$ | async)) ?? ''
                        }}
                        {{ tdValue ? columnData.postfix : '' }}
                      }
                    }
                  }
                </td>
              }
            </tr>
          } @empty {
            <tr class="empty-layer">
              <td colspan="100%">
                <div class="centered-text">{{ emptyText() }}</div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </tui-loader>
  </tui-scrollbar>

  <sproc-paginator
    class="register-table__paginator"
    [page]="page()"
    [rows]="limit()"
    [pageLinkSize]="1"
    [totalRecords]="totalRecords()"
    [totalNotFiltered]="totalNotFiltered()"
    [rowsCountOptions]="[30, 40, 50]"
    [selectedCounter]="selectedCounter()"
    (paginatorChange)="paginatorChange.emit($event)"
    [disabled]="paginatorDisabled()"
    [isLoading]="isPaginatorLoading()"
  >
  </sproc-paginator>
</section>
